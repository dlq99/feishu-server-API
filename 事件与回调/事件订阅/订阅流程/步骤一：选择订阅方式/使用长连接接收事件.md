# ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶äº‹ä»¶

é•¿è¿æ¥æ˜¯é£ä¹¦ SDK å†…æä¾›çš„èƒ½åŠ›ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°æœåŠ¡å™¨é›†æˆé£ä¹¦ SDKï¼Œ ä¸å¼€æ”¾å¹³å°å»ºç«‹ä¸€æ¡ WebSocket å…¨åŒå·¥é€šé“ï¼ˆä½ çš„æœåŠ¡å™¨éœ€è¦èƒ½å¤Ÿè®¿é—®å…¬ç½‘ï¼‰ã€‚åç»­å½“åº”ç”¨è®¢é˜…çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¼€æ”¾å¹³å°ä¼šé€šè¿‡è¯¥é€šé“å‘ä½ çš„æœåŠ¡å™¨å‘é€äº‹ä»¶æ¶ˆæ¯ã€‚

## åŠŸèƒ½ä¼˜åŠ¿

ç›¸è¾ƒäºä¼ ç»Ÿçš„ Webhook æ¨¡å¼ï¼Œé•¿è¿æ¥æ¨¡å¼å¤§å¤§é™ä½äº†æ¥å…¥æˆæœ¬ï¼Œå°†åŸå…ˆ 1 å‘¨å·¦å³çš„å¼€å‘å‘¨æœŸé™ä½åˆ° 5 åˆ†é’Ÿã€‚å…·ä½“ä¼˜åŠ¿å¦‚ä¸‹ï¼š

- **å¼€å‘è°ƒç”¨æ–¹ä¾¿å¿«æ·**
    
    åªéœ€ä¿è¯è¿è¡Œç¯å¢ƒå…·å¤‡è®¿é—®å…¬ç½‘çš„èƒ½åŠ›å³å¯ï¼Œæ— éœ€æä¾›å…¬ç½‘ IP æˆ–åŸŸåã€æ— éœ€ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·ï¼Œé€šè¿‡é•¿è¿æ¥æ¨¡å¼åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å³å¯æ¥æ”¶äº‹ä»¶æ¶ˆæ¯ï¼Œåç»­åœ¨çº¿ä¸Šéƒ¨ç½²æœ¬åœ°æœåŠ¡åä¹Ÿå¯ä»¥ç›´æ¥ç”Ÿæ•ˆã€‚
- **åŠ å¯†ä¼ è¾“ï¼Œæ— éœ€é¢å¤–å¤„ç†åŠ å¯†è§£å¯†é€»è¾‘**
    
    é•¿è¿æ¥æ–¹å¼å†…ç½®äº†é€šä¿¡é€šä¿¡åŠ å¯†å’Œé‰´æƒçš„é€»è¾‘ï¼Œäº‹ä»¶æ•°æ®ç½‘ç»œä¸Šä¼ è¾“æ—¶ä¸ºåŠ å¯†ä¼ è¾“ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€æ— éœ€é¢å¤–è§£å¯†ã€éªŒç­¾é€»è¾‘ï¼Œä¹Ÿæ— éœ€éƒ¨ç½²é˜²ç«å¢™å’Œé…ç½®ç™½åå•ã€‚

## æ³¨æ„äº‹é¡¹

åœ¨å¼€å§‹é…ç½®ä¹‹å‰ï¼Œä½ éœ€è¦ç¡®ä¿å·²äº†è§£ä»¥ä¸‹æ³¨æ„äº‹é¡¹ï¼š

- é•¿è¿æ¥æ¨¡å¼ä»…æ”¯æŒä¼ä¸šè‡ªå»ºåº”ç”¨ã€‚å•†åº—åº”ç”¨äº‹ä»¶è®¢é˜…æ–¹å¼å‚è€ƒå°†äº‹ä»¶å‘é€è‡³å¼€å‘è€…æœåŠ¡å™¨ã€‚
- é•¿è¿æ¥æ¨¡å¼ä¸‹æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦åœ¨ 3 ç§’å†…å¤„ç†å®Œæˆä¸”ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ä¼šè§¦å‘è¶…æ—¶é‡æ¨æœºåˆ¶ã€‚
- æ¯ä¸ªåº”ç”¨æœ€å¤šå»ºç«‹ 50 ä¸ªè¿æ¥ï¼ˆåœ¨é…ç½®é•¿è¿æ¥æ—¶ï¼Œæ¯åˆå§‹åŒ–ä¸€ä¸ª client å°±æ˜¯ä¸€ä¸ªè¿æ¥ï¼‰ã€‚
- é•¿è¿æ¥æ¨¡å¼çš„æ¶ˆæ¯æ¨é€ä¸º **é›†ç¾¤æ¨¡å¼**ï¼Œä¸æ”¯æŒå¹¿æ’­ï¼Œå³å¦‚æœåŒä¸€åº”ç”¨éƒ¨ç½²äº†å¤šä¸ªå®¢æˆ·ç«¯ï¼ˆclientï¼‰ï¼Œé‚£ä¹ˆåªæœ‰ **å…¶ä¸­éšæœºä¸€ä¸ª** å®¢æˆ·ç«¯ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚

## ä¸Šæ‰‹ä½“éªŒ

å¼€æ”¾å¹³å°æä¾›äº†ä¸€é”®å¼€å‘è‡ªåŠ¨å›å¤æœºå™¨äººçš„åœºæ™¯ä½“éªŒæ•™ç¨‹ï¼Œä½ å¯ä»¥å‰å¾€ä½“éªŒåŸºäºæ¥æ”¶æ¶ˆæ¯äº‹ä»¶æ‰€æ­å»ºçš„æœºå™¨äººåº”ç”¨ï¼Œè¯¦æƒ…å‚è§ï¼š

- ä¸€é”®å¿«é€Ÿå¼€å‘è‡ªåŠ¨å›å¤æœºå™¨äºº
- è‡ªåŠ¨å›å¤æœºå™¨äººç¤ºä¾‹ä»£ç è§£é‡Š

## æ­¥éª¤ä¸€ï¼šé›†æˆ SDK

ä»¥ä¸‹æä¾›äº†é£ä¹¦ SDK çš„ Golangã€Pythonã€Javaã€Node.js ç¤ºä¾‹ä»£ç ï¼Œä»£ç å†…ä»¥æ¥æ”¶æ¶ˆæ¯äº‹ä»¶ä¸ºä¾‹è¿›è¡Œé…ç½®ã€‚é€šè¿‡é£ä¹¦ SDK é™¤äº†å¯ä»¥å®ç°äº‹ä»¶è®¢é˜…ï¼Œè¿˜å¯ä»¥å®ç° API è°ƒç”¨ã€è®¢é˜…å›è°ƒï¼Œå…³äº SDK è¯¦ç»†ä»‹ç»å‚è§æœåŠ¡ç«¯ SDKã€‚

### Golang

#### å®‰è£… SDK

```
go get -u github.com/larksuite/oapi-sdk-go/v3
```

#### ç¤ºä¾‹ä»£ç 

```go
package main
import (
   "context"
   "fmt"
   larkcore "github.com/larksuite/oapi-sdk-go/v3/core"
   larkevent "github.com/larksuite/oapi-sdk-go/v3/event"
   "github.com/larksuite/oapi-sdk-go/v3/event/dispatcher"
   larkim "github.com/larksuite/oapi-sdk-go/v3/service/im/v1"
   larkws "github.com/larksuite/oapi-sdk-go/v3/ws"
)
func main() {
   // æ³¨å†Œäº‹ä»¶å›è°ƒï¼ŒOnP2MessageReceiveV1 ä¸ºæ¥æ”¶æ¶ˆæ¯ v2.0ï¼›OnCustomizedEvent å†…çš„ message ä¸ºæ¥æ”¶æ¶ˆæ¯ v1.0ã€‚
   eventHandler := dispatcher.NewEventDispatcher("", "").
      OnP2MessageReceiveV1(func(ctx context.Context, event *larkim.P2MessageReceiveV1) error {
         fmt.Printf("[ OnP2MessageReceiveV1 access ], data: %s\n", larkcore.Prettify(event))
         return nil
      }).
      OnCustomizedEvent("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„ event çš„ keyï¼Œä¾‹å¦‚ out_approval", func(ctx context.Context, event *larkevent.EventReq) error {
         fmt.Printf("[ OnCustomizedEvent access ], type: message, data: %s\n", string(event.Body))
         return nil
      })
   // åˆ›å»ºClient
   cli := larkws.NewClient("YOUR_APP_ID", "YOUR_APP_SECRET",
      larkws.WithEventHandler(eventHandler),
      larkws.WithLogLevel(larkcore.LogLevelDebug),
   )
   // å¯åŠ¨å®¢æˆ·ç«¯
   err := cli.Start(context.Background())
   if err != nil {
      panic(err)
   }
}
```


ä»£ç å®ç°è¯´æ˜ï¼š
1. é€šè¿‡ dispatcher.NewEventDispatcher() åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨ï¼ˆeventHandlerï¼‰ï¼Œæ³¨æ„**ä¸¤ä¸ªå‚æ•°å¿…é¡»å¡«ç©ºå­—ç¬¦ä¸²**ã€‚
1. é€šè¿‡ eventHandler çš„ OnXXXX() æ–¹æ³•å¤„ç†ä¸åŒçš„äº‹ä»¶ã€‚ä¸Šè¿°ç¤ºä¾‹ä¸­åˆ†åˆ«ç›‘å¬äº†ã€Œæ¥æ”¶æ¶ˆæ¯ v1.0ã€å’Œã€Œæ¥æ”¶æ¶ˆæ¯ v2.0ã€ä¸¤ä¸ªäº‹ä»¶ã€‚
    
   **è¯´æ˜**ï¼šå¼€æ”¾å¹³å°æä¾›çš„äº‹ä»¶åŒ…æ‹¬ v1.0 å’Œ v2.0 ä¸¤ä¸ªç‰ˆæœ¬ã€‚ä¸¤ä¸ªç‰ˆæœ¬çš„ç»“æ„ä¸åŒã€‚åœ¨å¤„ç†äº‹ä»¶æ—¶ï¼Œå¯é€šè¿‡äº‹ä»¶åˆ—è¡¨æ–‡æ¡£æˆ–åœ¨å¼€å‘è€…åå°æ·»åŠ äº‹ä»¶æ—¶ï¼Œè·å–äº‹ä»¶çš„ç±»å‹ä¸ç‰ˆæœ¬ä¿¡æ¯ã€‚

   ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/4dbc1cd97d95f1af949354ce3c350461_4PX46ts1Hs.png?height=380&lazyload=true&maxWidth=600&width=1666)
   

   å¦‚æœæ˜¯ v1.0 äº‹ä»¶ï¼Œåˆ™æ³¨å†ŒæœåŠ¡å™¨æ—¶éœ€è¦æŸ¥æ‰¾å¹¶ä½¿ç”¨ OnCustomizedEvent æ–¹æ³•ï¼›å¦‚æœæ˜¯ v2.0 äº‹ä»¶ï¼Œåˆ™æ³¨å†ŒæœåŠ¡å™¨æ—¶éœ€è¦æŸ¥æ‰¾å¹¶ä½¿ç”¨ onP2xxxx å¼€å¤´çš„æ–¹æ³•ã€‚
ä¾‹å¦‚ï¼Œä½¿ç”¨ `onP2MessageReceiveV1` æ³¨å†Œæ¥æ”¶æ¶ˆæ¯äº‹ä»¶å›è°ƒæ—¶ï¼Œ`P2`ä¾¿å¯¹åº”çš„æ˜¯ v2.0 ç‰ˆæœ¬äº‹ä»¶ç»“æ„ã€‚

   ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/8bbadcadbadcf70bb9cb4c44afea25cd_z7bPrzvx1l.png?height=286&lazyload=true&maxWidth=600&width=1598)
   
1. é€šè¿‡ larkws.NewClient() åˆå§‹åŒ–é•¿è¿æ¥å®¢æˆ·ç«¯ï¼Œå¿…å¡«å‚æ•°ä¸ºåº”ç”¨çš„ APP_ID å’Œ APP_SECRETï¼Œéœ€ç™»å½•[å¼€å‘è€…åå°](https://open.feishu.cn/app)ï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µçš„ **å‡­è¯ä¸åŸºç¡€ä¿¡æ¯** > **åº”ç”¨å‡­è¯** åŒºåŸŸè·å–ã€‚
    
    ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/f7f89950be7e57c2760a8b5b1f5e17c9_NouE7PqEkQ.png?height=524&lazyload=true&maxWidth=600&width=3594)
1. å¯é€‰å‚æ•°ä¼ å…¥ eventHandlerï¼ŒåŒæ—¶å¯è®¾ç½®æ—¥å¿—çº§åˆ«ã€‚
1. é€šè¿‡ cli.Start() å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå¦‚è¿æ¥æˆåŠŸï¼Œæ§åˆ¶å°ä¼šæ‰“å° "connected to wss://xxxxx"ï¼Œä¸»çº¿ç¨‹å°†é˜»å¡ï¼Œç›´åˆ°è¿›ç¨‹ç»“æŸã€‚
   
   ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/b1b3d6b4d3a724fa7408f5c71a11d19e_ysuov6r3Bn.png?height=338&lazyload=true&maxWidth=600&width=2286)

### Python

#### å®‰è£… SDK

```
pip install lark-oapi -U
```

#### ç¤ºä¾‹ä»£ç 

```python
import lark_oapi as lark

## P2ImMessageReceiveV1 ä¸ºæ¥æ”¶æ¶ˆæ¯ v2.0ï¼›CustomizedEvent å†…çš„ message ä¸ºæ¥æ”¶æ¶ˆæ¯ v1.0ã€‚

def do_p2_im_message_receive_v1(data: lark.im.v1.P2ImMessageReceiveV1) -> None:
    print(f'[ do_p2_im_message_receive_v1 access ], data: {lark.JSON.marshal(data, indent=4)}')
def do_message_event(data: lark.CustomizedEvent) -> None:
    print(f'[ do_customized_event access ], type: message, data: {lark.JSON.marshal(data, indent=4)}')
event_handler = lark.EventDispatcherHandler.builder("", "") \
    .register_p2_im_message_receive_v1(do_p2_im_message_receive_v1) \
    .register_p1_customized_event("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„ event çš„ keyï¼Œä¾‹å¦‚ out_approval", do_message_event) \
    .build()
def main():
    cli = lark.ws.Client("YOUR_APP_ID", "YOUR_APP_SECRET",
                         event_handler=event_handler,
                         log_level=lark.LogLevel.DEBUG)
    cli.start()
if __name__ == "__main__":
    main()
```

ä»£ç å®ç°è¯´æ˜ï¼š

1. é€šè¿‡ lark.EventDispatcherHandler.builder() åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨ï¼ˆevent_handlerï¼‰ï¼Œè¯¥æ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°å¿…é¡»å¡«ç©ºå­—ç¬¦ä¸²ã€‚

2. é€šè¿‡ event_handler çš„ `register_{äº‹ä»¶ç‰ˆæœ¬}_{äº‹ä»¶ç±»å‹ æˆ– customized_event}` æ–¹æ³•å¤„ç†ä¸åŒçš„äº‹ä»¶ã€‚

    åœ¨å¼€å‘è€…åå°åº”ç”¨è¯¦æƒ…é¡µæ·»åŠ äº‹ä»¶æ—¶ï¼ˆå…·ä½“æ“ä½œå¯å‚è§æ·»åŠ äº‹ä»¶ï¼‰ï¼Œå¯è·å–äº‹ä»¶çš„ç±»å‹ä¸ç‰ˆæœ¬ä¿¡æ¯ã€‚

	![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/4dbc1cd97d95f1af949354ce3c350461_bidnBwXPPi.png?height=380&lazyload=true&maxWidth=600&width=1666)

	**v2.0 ç‰ˆæœ¬çš„äº‹ä»¶**
    
	- ä½¿ç”¨`data: lark.im.v1.P2ImMessageReceiveV1` æŒ‡å®šæ‰€é€‰äº‹ä»¶ï¼Œå…¶ä¸­ï¼š
    
  		- `lark.im.v1`è¡¨ç¤ºå¯¹åº”çš„ä¸šåŠ¡åŸŸä»¥åŠç‰ˆæœ¬ï¼Œå¯é€šè¿‡äº‹ä»¶ç±»å‹çš„å‰ç¼€è·å–ä¸šåŠ¡åŸŸä»£ç ï¼Œä¾‹å¦‚ `im.message.receive_v1` å¯¹åº”çš„ä¸šåŠ¡åŸŸä»£ç ä¸º `im`ã€‚
    
  		- `P2ImMessageReceiveV1` ä¸­ï¼Œ**P2** è¡¨ç¤ºäº‹ä»¶ç‰ˆæœ¬ä¸º v2.0ï¼Œ**ImMessageReceiveV1** å¯¹åº”äº‹ä»¶ç±»å‹ `im.message.receive_v1`ã€‚

	- ä½¿ç”¨ `.register_p2_im_message_receive_v1()` å¤„ç†äº‹ä»¶ï¼Œå…¶ä¸­ï¼š
    
  		- **p2** è¡¨ç¤ºäº‹ä»¶ç‰ˆæœ¬ä¸º v2.0ã€‚
    
  		- **im_message_receive_v1** å¯¹åº”äº‹ä»¶ç±»å‹ `im.message.receive_v1`ã€‚

	

> **ğŸ“ æ³¨æ„**
> **è¯´æ˜**ï¼šä»£ç ä¸­çš„æ–¹æ³•æ ¼å¼ä¸äº‹ä»¶ç±»å‹ä¸ä¸€è‡´ï¼Œæ³¨æ„ç”„åˆ«æ ¼å¼ä¸Šçš„å·®å¼‚ï¼Œé¿å…å› æ ¼å¼é—®é¢˜å¯¼è‡´ç¨‹åºè¿è¡Œå¤±è´¥ã€‚


    
    **v1.0 ç‰ˆæœ¬çš„äº‹ä»¶**

	- å›ºå®šä½¿ç”¨ `data: lark.CustomizedEvent` æ–¹æ³•ï¼Œè¡¨ç¤ºå¤„ç†è‡ªå®šä¹‰äº‹ä»¶ã€‚
	- ä½¿ç”¨ `.register_p1_customized_event("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„äº‹ä»¶ç±»å‹ï¼Œä¾‹å¦‚ out_approval", do_message_event)` å¤„ç†äº‹ä»¶ï¼š
    	- **p1** è¡¨ç¤ºäº‹ä»¶ç‰ˆæœ¬ä¸º v1.0ã€‚
    	- **customized_event** ä¸ºå›ºå®šçš„æ–¹æ³•åç§°ã€‚
    	- customized_event æ–¹æ³•å†…éœ€è¦ä¼ å…¥äº‹ä»¶ Keyï¼ˆString ç±»å‹ï¼‰ï¼Œä¾‹å¦‚å¤–å‡ºå®¡æ‰¹çš„äº‹ä»¶ç±»å‹ä¸º out_approvalã€‚

    
    ä½ ä¹Ÿå¯ä»¥å‚è€ƒä»£ç ç‰‡æ®µæ³¨é‡Šäº†è§£å¦‚ä½•é…ç½®ï¼š
    
    ```python
    ## P2ImMessageReceiveV1ï¼š
    ## P2 å¯¹åº” v2.0 ç‰ˆæœ¬ï¼Œ
    ## ImMessageReceiveV1 å¯¹åº”æ¥æ”¶æ¶ˆæ¯äº‹ä»¶ç±»å‹ im.message.receive_v1ã€‚
    def do_p2_im_message_receive_v1(data: lark.im.v1.P2ImMessageReceiveV1) -> None:
        print(f'[ do_p2_im_message_receive_v1 access ], data: {lark.JSON.marshal(data, indent=4)}')

    ## å¦‚æœæ˜¯ v1.0 ç‰ˆæœ¬äº‹ä»¶ï¼Œéœ€è¦ä½¿ç”¨ lark.CustomizedEvent
    def do_message_event(data: lark.CustomizedEvent) -> None:
        print(f'[ do_customized_event access ], type: message, data: {lark.JSON.marshal(data, indent=4)}')

    event_handler = lark.EventDispatcherHandler.builder("", "") \
        ## register_p2 å¯¹åº” v2.0 ç‰ˆæœ¬ï¼Œ
        ## im_message_receive_v1 å¯¹åº”æ¥æ”¶æ¶ˆæ¯äº‹ä»¶ç±»å‹ im.message.receive_v1ã€‚
        .register_p2_im_message_receive_v1(do_p2_im_message_receive_v1) \
        ## register_p1 å¯¹åº” v1.0 ç‰ˆæœ¬ï¼Œ
        ## å‚æ•°å€¼éœ€è¦ä¼ å…¥äº‹ä»¶ç±»å‹ã€‚ä¾‹å¦‚ out_approval
        .register_p1_customized_event("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„ event çš„ keyï¼Œä¾‹å¦‚ out_approval", do_message_event) \
        .build()
    ```

3. é€šè¿‡ lark.ws.Client() åˆå§‹åŒ–é•¿è¿æ¥å®¢æˆ·ç«¯ï¼Œå¿…å¡«å‚æ•°ä¸ºåº”ç”¨çš„ APP_ID å’Œ APP_SECRETï¼Œéœ€ç™»å½•[å¼€å‘è€…åå°](https://open.feishu.cn/app)ï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µçš„ **å‡­è¯ä¸åŸºç¡€ä¿¡æ¯** > **åº”ç”¨å‡­è¯** åŒºåŸŸè·å–ã€‚
    
    ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/f7f89950be7e57c2760a8b5b1f5e17c9_QVldl2kW9x.png?height=524&lazyload=true&maxWidth=600&width=3594)

4. å¯é€‰å‚æ•°ä¼ å…¥ event_handlerï¼ŒåŒæ—¶å¯è®¾ç½®æ—¥å¿—çº§åˆ«ã€‚
5. é€šè¿‡ cli.start() å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå¦‚è¿æ¥æˆåŠŸï¼Œæ§åˆ¶å°ä¼šæ‰“å° "connected to wss://xxxxx"ï¼Œä¸»çº¿ç¨‹å°†é˜»å¡ï¼Œç›´åˆ°è¿›ç¨‹ç»“æŸã€‚
    
    ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/2085839331117b6f9817482a5493eba6_mDSqdoypa5.png?height=264&lazyload=true&maxWidth=600&width=2488)

### Java

#### å®‰è£… SDK

SDK æœ€æ–°ç‰ˆæœ¬å¯ä»¥åœ¨[è¿™é‡Œ](https://mvnrepository.com/artifact/com.larksuite.oapi/oapi-sdk)æŸ¥çœ‹ã€‚

```xml
<dependencies>
  ...
  <dependency>
    <groupId>com.larksuite.oapi</groupId>
    <artifactId>oapi-sdk</artifactId>
    <version>{latest version}</version>
  </dependency>
  ...
</dependencies>
```


#### ç¤ºä¾‹ä»£ç 

```java
package com.lark.oapi.sample.ws;
import com.lark.oapi.core.request.EventReq;
import com.lark.oapi.core.utils.Jsons;
import com.lark.oapi.event.CustomEventHandler;
import com.lark.oapi.event.EventDispatcher;
import com.lark.oapi.service.im.ImService;
import com.lark.oapi.service.im.v1.model.P2MessageReceiveV1;
import com.lark.oapi.ws.Client;
import java.nio.charset.StandardCharsets;
public class Sample {
          // onP2MessageReceiveV1 ä¸ºæ¥æ”¶æ¶ˆæ¯ v2.0ï¼›onCustomizedEvent å†…çš„ message ä¸ºæ¥æ”¶æ¶ˆæ¯ v1.0ã€‚
    private static final EventDispatcher EVENT_HANDLER = EventDispatcher.newBuilder("", "")
            .onP2MessageReceiveV1(new ImService.P2MessageReceiveV1Handler() {
                @Override
                public void handle(P2MessageReceiveV1 event) throws Exception {
                    System.out.printf("[ onP2MessageReceiveV1 access ], data: %s\n", Jsons.DEFAULT.toJson(event.getEvent()));
                }
            })
            .onCustomizedEvent("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„ event çš„ keyï¼Œä¾‹å¦‚ out_approval", new CustomEventHandler() {
                @Override
                public void handle(EventReq event) throws Exception {
                    System.out.printf("[ onCustomizedEvent access ], type: message, data: %s\n", new String(event.getBody(), StandardCharsets.UTF_8));
                }
            })
            .build();
    public static void main(String[] args) {
        Client cli = new Client.Builder("YOUR_APP_ID", "YOUR_APP_SECRET")
                .eventHandler(EVENT_HANDLER)
                .build();
        cli.start();
    }
}
```

ä»£ç å®ç°è¯´æ˜ï¼š
1. é€šè¿‡ EventDispatcher.*newBuilder*() åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨ï¼ˆ*EVENT_HANDLER*ï¼‰ï¼Œæ³¨æ„**ä¸¤ä¸ªå‚æ•°å¿…é¡»å¡«ç©ºå­—ç¬¦ä¸²**ã€‚
1. é€šè¿‡ *EVENT_HANDLER* çš„ onXXXX() æ–¹æ³•å¤„ç†ä¸åŒçš„äº‹ä»¶ã€‚ä¸Šè¿°ç¤ºä¾‹ä¸­åˆ†åˆ«ç›‘å¬äº†ã€Œæ¥æ”¶æ¶ˆæ¯ v1.0ã€å’Œã€Œæ¥æ”¶æ¶ˆæ¯ v2.0ã€ä¸¤ä¸ªäº‹ä»¶ã€‚
    
   **è¯´æ˜**ï¼šå¼€æ”¾å¹³å°æä¾›çš„äº‹ä»¶åŒ…æ‹¬ v1.0 å’Œ v2.0 ä¸¤ä¸ªç‰ˆæœ¬ã€‚ä¸¤ä¸ªç‰ˆæœ¬çš„ç»“æ„ä¸åŒã€‚åœ¨å¤„ç†äº‹ä»¶æ—¶ï¼Œå¯é€šè¿‡äº‹ä»¶åˆ—è¡¨æ–‡æ¡£æˆ–åœ¨å¼€å‘è€…åå°æ·»åŠ äº‹ä»¶æ—¶ï¼Œè·å–äº‹ä»¶çš„ç±»å‹ä¸ç‰ˆæœ¬ä¿¡æ¯ã€‚

   ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/4dbc1cd97d95f1af949354ce3c350461_4PX46ts1Hs.png?height=380&lazyload=true&maxWidth=600&width=1666)
   

   å¦‚æœæ˜¯ v1.0 äº‹ä»¶ï¼Œåˆ™æ³¨å†ŒæœåŠ¡å™¨æ—¶éœ€è¦æŸ¥æ‰¾å¹¶ä½¿ç”¨ onP1xxxx å¼€å¤´çš„æ–¹æ³•ï¼›å¦‚æœæ˜¯ v2.0 äº‹ä»¶ï¼Œåˆ™æ³¨å†ŒæœåŠ¡å™¨æ—¶éœ€è¦æŸ¥æ‰¾å¹¶ä½¿ç”¨ onP2xxxx å¼€å¤´çš„æ–¹æ³•ã€‚
ä¾‹å¦‚ï¼Œä½¿ç”¨ `onP2MessageReceiveV1` æ³¨å†Œæ¥æ”¶æ¶ˆæ¯äº‹ä»¶å›è°ƒæ—¶ï¼Œ`P2`ä¾¿å¯¹åº”çš„æ˜¯ v2.0 ç‰ˆæœ¬äº‹ä»¶ç»“æ„ã€‚

   ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/8bbadcadbadcf70bb9cb4c44afea25cd_z7bPrzvx1l.png?height=286&lazyload=true&maxWidth=600&width=1598)

    
1. é€šè¿‡ new Client.Builder() åˆå§‹åŒ–é•¿è¿æ¥å®¢æˆ·ç«¯ï¼Œå¿…å¡«å‚æ•°ä¸ºåº”ç”¨çš„ APP_ID å’Œ APP_SECRETï¼Œéœ€ç™»å½•[å¼€å‘è€…åå°](https://open.feishu.cn/app)ï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µçš„ **å‡­è¯ä¸åŸºç¡€ä¿¡æ¯** > **åº”ç”¨å‡­è¯** åŒºåŸŸè·å–ã€‚

     ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/f7f89950be7e57c2760a8b5b1f5e17c9_1BhhLr3htD.png?height=524&lazyload=true&maxWidth=600&width=3594)
     
1. å¯é€‰å‚æ•°ä¼ å…¥ *EVENT_HANDLER*ï¼ŒåŒæ—¶å¯è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œå¯åœ¨é¡¹ç›®çš„æ—¥å¿—æ¡†æ¶ï¼ˆlog4j2ã€logbackç­‰ï¼‰é…ç½®ä¸­ä¿®æ”¹ã€‚
1. é€šè¿‡ cli.start() å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå¦‚è¿æ¥æˆåŠŸï¼Œæ§åˆ¶å°ä¼šæ‰“å° "connected to wss://xxxxx"ï¼Œä¸»çº¿ç¨‹å°†é˜»å¡ï¼Œç›´åˆ°è¿›ç¨‹ç»“æŸã€‚
   
   ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/90d8aab594e3fa8ca22bf4b291723efd_8BitTMiPGo.png?height=176&lazyload=true&maxWidth=600&width=2992)

### Node.js

#### å®‰è£… SDK

ç‰ˆæœ¬éœ€å¤§äºç­‰äº`1.24.0`ã€‚

```
// ç”¨è‡ªå·±é¡¹ç›®ä¸­çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå¦‚ yarn
yarn add @larksuiteoapi/node-sdk
```

#### ç¤ºä¾‹ä»£ç 

```js
import * as Lark from '@larksuiteoapi/node-sdk';
const baseConfig = {
  appId: 'xxx',
  appSecret: 'xxx'
}
const client = new Lark.Client(baseConfig);
const wsClient = new Lark.WSClient({...baseConfig, loggerLevel: Lark.LoggerLevel.debug});
wsClient.start({
  // å¤„ç†ã€Œæ¥æ”¶æ¶ˆæ¯ã€äº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹ä¸º im.message.receive_v1
  eventDispatcher: new Lark.EventDispatcher({}).register({
    'im.message.receive_v1': async (data) => {
      const {
        message: { chat_id, content}
      } = data;
      // ç¤ºä¾‹æ“ä½œï¼šæ¥æ”¶æ¶ˆæ¯åï¼Œè°ƒç”¨ã€Œå‘é€æ¶ˆæ¯ã€API è¿›è¡Œæ¶ˆæ¯å›å¤ã€‚
      await client.im.v1.message.create({
        params: {
          receive_id_type: "chat_id"
        },
        data: {
          receive_id: chat_id,
          content: Lark.messageCard.defaultCard({
            title: `å›å¤ï¼š ${JSON.parse(content).text}`,
            content: 'æ–°å¹´å¥½'
          }),
          msg_type: 'interactive'
        }
      });
    }
  })
});
```

ä»£ç å®ç°è¯´æ˜ï¼š

1. åˆå§‹åŒ– WSClientã€‚
    
    1. åœ¨ baseConfig ä¸­ï¼Œä¼ å…¥åº”ç”¨çš„ appIdã€appSecretã€‚è·å–æ–¹å¼ï¼šç™»å½•[å¼€å‘è€…åå°](https://open.feishu.cn/app)ï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µçš„ **å‡­è¯ä¸åŸºç¡€ä¿¡æ¯** é¡µé¢å†…ï¼Œè·å–åº”ç”¨å‡­è¯ï¼ˆåŒ…æ‹¬ App ID å’Œ App Secretï¼‰ã€‚
        
        ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/e78da7b6e674f8ab77a16313123d60b0_I9ZxXgd9Qe.png?height=356&lazyload=true&maxWidth=600&width=2536)
    
    1. å¯é€‰æ·»åŠ  domain ç­‰å…¶ä»–å‚æ•°ï¼Œdomain é»˜è®¤ä¸º `open.feishu.cn`ã€‚
        
        Client æ”¯æŒé…ç½®çš„å‚æ•°å‚è€ƒè°ƒç”¨æœåŠ¡ç«¯ API ä¸­çš„ **æ­¥éª¤ä¸€ï¼šåˆ›å»ºå¹¶é…ç½® API Client** ç« èŠ‚ã€‚

2. åŸºäº Client å®Œæˆåˆå§‹åŒ–æ—¶ï¼Œå®ä¾‹ä¸Šçš„ start æ–¹æ³•ç”¨äºå¯åŠ¨é•¿è¿æ¥å®¢æˆ·ç«¯ã€‚
    
    å…¶ä¸­ï¼Œstart å‡½æ•°ä¸­çš„ eventDispatcher å‚æ•°æ¥æ”¶ EventDispatcher å®ä¾‹ï¼Œé•¿è¿æ¥å®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸåï¼ŒeventDispatcher.register æ³¨å†Œçš„ç›¸å…³äº‹ä»¶ handler ä¼šè¢«æ‰§è¡Œã€‚
    
    å¦‚ä¸‹ç¤ºä¾‹ä»£ç éƒ¨åˆ†ï¼Œéœ€è¦å°† `'im.message.receive_v1'` æ›¿æ¢ä¸ºéœ€è¦å¤„ç†çš„äº‹ä»¶çš„ **äº‹ä»¶ç±»å‹**ã€‚**äº‹ä»¶ç±»å‹** å¯å‚è€ƒæŒ‡å®šäº‹ä»¶çš„æ–‡æ¡£ï¼Œä¾‹å¦‚ï¼ŒæŸ¥é˜…æ¥æ”¶æ¶ˆæ¯äº‹ä»¶æ–‡æ¡£å¯çŸ¥ï¼Œè¯¥äº‹ä»¶çš„äº‹ä»¶ç±»å‹ä¸º **im.message.receive_v1**ã€‚
    
    ```javascript
    wsClient.start({
      eventDispatcher: new Lark.EventDispatcher({}).register({
        'im.message.receive_v1': async (data) => {
          const {
            message: { chat_id, content}
          } = data;
    ```
    
    å¦‚æˆåŠŸå¯åŠ¨é•¿è¿æ¥ï¼Œä¼šæ‰“å°å¦‚ä¸‹ä¿¡æ¯ã€‚
    
    ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/a5139264b8e6fcbbeafce287aa86efec_YGMzsCtK7W.png?height=694&lazyload=true&maxWidth=600&width=3124)

## æ­¥éª¤äºŒï¼šè®¾ç½®è®¢é˜…æ–¹å¼

1. å¯åŠ¨æœ¬åœ°é•¿è¿æ¥å®¢æˆ·ç«¯ã€‚
    
    å…·ä½“æ“ä½œå‚è€ƒä¸Šè¿° **æ­¥éª¤ä¸€ï¼šé›†æˆ SDK**ã€‚

2. ç™»å½•[å¼€å‘è€…åå°](https://open.feishu.cn/app)ï¼Œé€‰æ‹©ä¸€ä¸ªä¼ä¸šè‡ªå»ºåº”ç”¨ã€‚
    
    ç›®å‰é•¿è¿æ¥æ¨¡å¼ä¸æ”¯æŒå•†åº—åº”ç”¨ã€‚

3. è¿›å…¥ **äº‹ä»¶ä¸å›è°ƒ > äº‹ä»¶é…ç½®** é¡µé¢ã€‚

4. ç¼–è¾‘è®¢é˜…æ–¹å¼ï¼Œé€‰æ‹© **ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶äº‹ä»¶**ï¼Œå¹¶ä¿å­˜ã€‚


    

> **âš ï¸ è­¦å‘Š**
> å¿…é¡»ç¡®ä¿æœ¬åœ°å®¢æˆ·ç«¯å¯åŠ¨æ­£å¸¸ï¼Œæœ‰é•¿è¿æ¥åœ¨çº¿çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½ä¿å­˜æˆåŠŸã€‚


    
    ![](//sf3-cn.feishucdn.com/obj/open-platform-opendoc/cb9b31525ac1bf0be297feba0eb264b4_b2P2yQrvFW.png?height=790&lazyload=true&maxWidth=600&width=1726)

## å¸¸è§é—®é¢˜

é…ç½®è¿‡ç¨‹ä¸­å¦‚é‡é—®é¢˜ï¼Œå¯å‚è€ƒå¸¸è§é—®é¢˜æ’æŸ¥è§£å†³ã€‚
